---
title: "Darwin Core checklist mapping"
subtitle: "For: Checklist title"
author:
- author_1
- author_2
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
---

# General setup 

```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Load libraries:

```{r}
library(tidyverse)       # To transform data
library(magrittr)        # For %<>% pipes
library(janitor)         # To clean input data
library(readxl)          # To read Excel files
library(digest)          # To generate hashes
library(rgbif)
library(stringi)
```

# Read raw data

Create a data frame `raw_data` from the source data `checklist.xlsx`:

```{r}
raw_data <- read_excel(path = "../data/raw/checklist.xlsx") 
```

# Preprocess raw data

## Data structure

```{r}
raw_data %<>%
  remove_empty("rows") %>%       # Remove empty rows
  clean_names()                  # Have sensible (lowercase) column names
```

Add prefix `raw_` to all column names to avoid name clashes with Darwin Core terms:

```{r}
colnames(raw_data) <- paste0("raw_", colnames(raw_data))
```

## Preview data

```{r}
raw_data %>% head(n = 5)
```

## Scientific names

```{r}
```


```{r}
```


# Darwin Core mapping



### Generate taxonID

```{r}

vdigest <- Vectorize(digest)  # Vectorize digest function to generate `taxonID`:

raw_data %<>% mutate(raw_taxon_id = paste(
  "dataset_shortname", 
  "taxon", 
  vdigest(paste(
    raw_scientific_name, raw_kingdom),  
  algo="md5"), sep=":"))
```


# Create taxon core

```{r}
taxon <- raw_data
```

## Pre-processing


Check for duplicates:

```{r}
duplicates <- taxon %>%  
  slice(which(duplicated(taxon $ raw_scientific_name) == "TRUE")) %>% 
  select(raw_scientific_name) 
```

```{r, echo=FALSE}
duplicates
```

Should contain zero rows.
If not: inspect dataset for more information on these species:

```{r}
taxon %>% filter(raw_scientific_name %in% duplicates $ raw_scientific_name)
```


Remove duplicated rows:

```{r}
taxon %<>% slice(which(duplicated(taxon $ raw_scientific_name)==FALSE))
```

## Term mapping
 
Map the data to [Darwin Core Taxon](http://rs.gbif.org/core/dwc_taxon_2015-04-24.xml).


### language

```{r}
taxon %<>% mutate(language = "") 
```

### license

```{r}
taxon %<>% mutate(license = "") 
```

### rightsHolder

```{r}
taxon %<>% mutate(rightsHolder = "") 
```

### accessRights

```{r}
taxon %<>% mutate(accessRights = "") 
```

### datasetID

```{r}
taxon %<>% mutate(datasetID = "") 
```

### institutionCode

```{r}
taxon %<>% mutate(institutionCode = "")
```

### datasetName

```{r}
taxon %<>% mutate(datasetName = "") 
```


```{r}
taxon %>% distinct(raw_kingdom)
```
```{r}
taxon %>% select(raw_kingdom) %>% group_by_all() %>% summarize(records = n())
```

### taxonID

```{r}
taxon %<>% mutate(taxonID = raw_taxon_id) 
```

### scientificName

```{r}
taxon %<>% mutate(scientificName = raw_scientific_name) 
```

### kingdom

```{r}
taxon %<>% mutate(kingdom = raw_kingdom) 
```

### taxonRank

Add taxonRank information

```{r}
parsenames(taxon $ raw_scientific_name)
```

Add taxonRank information in rankmarker to dataset:

```{r}
taxon %<>% left_join(
  select(parsenames(taxon $ scientificName), c(scientificname, rankmarker)),
  by = c("scientificName" = "scientificname"))
```

Inspect information in taxonRank:

```{r}
taxon %>% distinct(rankmarker)
```

Recode rankmarker information into `taxonRank`:

```{r}
taxon %<>% mutate(taxonRank = recode(rankmarker,
   "sp." = "species",
   "var." = "variety",
   "infrasp." = "infraspecies")) 
```

### nomenclaturalCode

```{r}
taxon %<>% mutate(nomenclaturalCode = "") 
```

## Post-processing

Remove the original columns:

```{r}
taxon %<>% select(-starts_with("raw_"))
```

Preview data:

```{r}
taxon %>% head()
```

Save to CSV:

```{r}
write.csv(taxon, file = "../data/processed/taxon.csv", na = "", row.names = FALSE, fileEncoding = "UTF-8")
```

# Create distribution extension

```{r}
distribution <- raw_data
```

## Term mapping 

Map the data to [Species Distribution](http://rs.gbif.org/extension/gbif/1.0/distribution.xml).

### taxonID

```{r}
distribution %<>% mutate(taxonID = raw_taxon_id) 
```

### locality

Inspect values:

```{r}
distribution %>% 
  select(raw_locality, raw_country_code) %>% 
  group_by_all() %>% 
  summarize(records = n())
```

Use `case_when` in this case.
When `raw_locality` is empty, use country as a locality:

```{r}
distribution %<>% mutate(locality = case_when(
  is.na(raw_locality) & raw_country_code == "BE" ~ "Belgium",
  is.na(raw_locality) & raw_country_code == "FR" ~ "France",
  is.na(raw_locality) & raw_country_code == "MK" ~ "Macedonia",
  is.na(raw_locality) & raw_country_code == "NL" ~ "The Netherlands",
  TRUE ~ raw_locality))
```


```{r}
distribution %>% 
  select(raw_locality, raw_country_code, locality) %>% 
  group_by_all() %>% 
  summarize(records = n())
```

### countryCode

```{r}
distribution %<>% mutate(countryCode = raw_country_code) 
```

### occurrenceStatus

```{r}
distribution %<>% mutate(occurrenceStatus = raw_occurrence_status) 
```

### threatStatus

recode threatStatus:

```{r}
distribution %<>% mutate(threatStatus = recode(raw_threat_status,
  "endangered" = "EN",
  "vulnerable" = "VU"))
```

### source

```{r}
distribution %<>% mutate(source = raw_source) 
```

### occurrenceRemarks

```{r}
distribution %<>% mutate(occurrenceRemarks = raw_remarks) 
```

## Post-processing

Remove the original columns:

```{r}
distribution %<>% select(-starts_with("raw_"))
```

Preview data:

```{r}
distribution %>% head()
```

Save to CSV:

```{r}
write.csv(taxon, file = "../data/processed/taxon.csv", na = "", row.names = FALSE, fileEncoding = "UTF-8")
```




