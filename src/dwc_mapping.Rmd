---
title: "Darwin Core checklist mapping"
subtitle: "For: Checklist title"
author:
- author_1
- author_2
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
---


# Setup

```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Use UTF-8 character encoding:

LR: Hier verschillende codering voor verschillende OS geven:

```{r}
# This works on Mac OS X, might not work on other OS
Sys.setlocale("LC_CTYPE", "en_US.UTF-8")
```

Load libraries:

```{r}
library(tidyverse)       # To transform data
library(magrittr)        # For %<>% pipes
library(readxl)          # To read Excel files
library(digest)          # To generate hashes
library(rgbif)
library(inborutils)     
library(assertthat)
library(assertable)
```

Vectorize digest function to generate `taxonID`:
LR: dit eventueel onzichtbaar zetten

```{r}
vdigest <- Vectorize(digest)
```


# Read and pre-process raw data

Create a data frame `raw_data` from the source data:

```{r}
raw_data <- read_excel(path = "../data/raw/checklist.xlsx") 
```

Generate taxon_ID:

```{r}
raw_data %<>% mutate(taxon_id = paste("dataset_shortname", "taxon", vdigest(scientific_name, algo="md5"), sep=":"))
```


# Create taxon core

## Pre-processing

Check for duplicates:

```{r}
duplicates <- raw_data %>%  
  slice(which(duplicated(raw_data $ scientific_name) == "TRUE")) %>% 
  select(scientific_name)
```

```{r, echo=FALSE}
duplicates
```

Should contain zero rows.
If not: inspect dataset for more information on these species:

```{r}
raw_data %>% filter(scientific_name %in% duplicates $ scientific_name)
```

The difference should be in the `locality` information.

Remove duplicated rows:

```{r}
raw_data %<>% filter(duplicated(raw_data $ scientific_name)==FALSE)
```

LR: wat als er andere informatie verschilt, i.e. in het geval van hemihomonymen? Dan eventueel een combinatie maken van de taxon naam en de factor waar beiden in verschillen. Dit ofwel integreren in de begeleidende tekst ofwel in een afzonderlijk script

## Term mapping
 
Map the data to [Darwin Core Taxon](http://rs.gbif.org/core/dwc_taxon_2015-04-24.xml).

### taxonID

### scientificName

```{r}
taxon %<>% mutate(scientificName = raw_scientific_name) 
```

### Add classification information

```{r}
gbif_species_name_match(raw_data, name_col = "scientific_name", 
                                        gbif_terms = c('usageKey', 'scientificName', 'rank', 'matchType', 
                                                       'kingdom', 'phylum', 'class', 'order', 'family', 
                                                       'genus', 'confidence', 'synonym', 'status'))
```

